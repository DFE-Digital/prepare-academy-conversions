@page "/project-list"
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model Dfe.PrepareConversions.Pages.ProjectList.IndexModel
@{
    ViewData["Title"] = "Project list";
}

@functions {

    bool ShowHtbDate(ProjectListViewModel vm)
    {
        return !string.IsNullOrWhiteSpace(vm.HeadTeacherBoardDate);
    }

}

@section BeforeMain
    {
    <a asp-page="@Links.ProjectType.Index.Page" class="govuk-back-link" data-cy="select-backlink">@Links.ProjectType.Index.BackText</a>
}

    @if (Model.Filters.IsVisible)
{
    <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner"
     data-cy="select-projectlist-filter-banner">
        <div class="govuk-notification-banner__header">
            <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                Success
            </h2>
        </div>
        <div class="govuk-notification-banner__content">
            <h3 class="govuk-notification-banner__heading">
                Projects filtered.
            </h3>
        </div>
    </div>
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-xl" data-cy="select-heading">Manage an academy conversion</h1>
        <p class="govuk-body">Use this service to start a new involuntary conversion project or update an existing conversion project.</p>
        <a asp-page="@Links.InvoluntaryProject.SearchSchool.Page" role="button" draggable="false" class="govuk-button" data-module="govuk-button">
            Start a new involuntary conversion project
        </a>

        <h2 class="govuk-heading-l" test-id="projectCount" data-cy="select-projectlist-filter-count">@(@Model.TotalProjects) projects found</h2>

        <partial name="Shared/_ProjectListFilters" model="Model.Filters" />

        @{
            if (Model.ProjectCount == 0)
            {
                <div class="govuk-heading-m govuk-!-margin-top-3">There are no matching results.</div>
                <p class="govuk-body">Improve your results by:</p>
                <ul class="govuk-list govuk-list--bullet govuk-body">
                    <li>double-checking your spelling</li>
                    <li>searching again with another school</li>
                    <li>removing some filters</li>
                </ul>
            }
            else
            {
                <div class="sort-component">
                    <nav class="govuk-body sort-component__nav" aria-label="sort-by">
                        <span class="govuk-!-font-weight-bold">Sorted by:</span> Project created date
                    </nav>
                </div>
                <table class="govuk-table">
                    <caption class="govuk-table__caption govuk-table__caption--m govuk-visually-hidden">Projects (@Model.ProjectCount)</caption>
                    <thead class="govuk-table__head">
                        <tr class="govuk-table__row">
                            <th class="govuk-table__header app-!-width-three-fifths">Application information</th>
                            <th class="govuk-table__header govuk-!-text-align-right app-!-width-two-fifths prepare-text-align-right">Project status and dates</th>
                        </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                        @{
                            var index = 0;
                            foreach (ProjectListViewModel project in Model.Projects)
                            {
                                <tr class="govuk-table__row" data-cy="select-projectlist-filter-row">
                                    <td class="govuk-table__cell">
                                        <h2 class="govuk-caption-l govuk-!-margin-bottom-0 govuk-!-margin-top-1">
                                            <strong>
                                                <a id="@("school-name-" + index)" class="govuk-link" asp-page="@Links.TaskList.Index.Page" asp-route-id="@project.Id">@project.SchoolName</a>
                                            </strong>
                                            <span id="@("urn-" + index)">URN: @project.SchoolURN</span>
                                        </h2>
                                        <p class="govuk-!-margin-top-3">
                                            <div data-cy="route">Route: @(string.IsNullOrWhiteSpace(project.ApplicationReceivedDate) ? "Involuntary conversion" : "Voluntary conversion")</div>
                                            <div id="@("application-to-join-trust-" + index)">Application to join a trust: @project.NameOfTrust</div>
                                            <div id="@("local-authority-" + index)">Local authority: @project.LocalAuthority</div>
                                            @if (string.IsNullOrWhiteSpace(project.AssignedUserFullName))
                                            {
                                                <div id="@("delivery-officer-" + index)">Delivery officer: <span class="empty">Empty</span></div>
                                            }
                                            else
                                            {
                                                <div id="@("delivery-officer-" + index)">Delivery officer: <strong>@project.AssignedUserFullName</strong></div>
                                            }
                                        </p>
                                    </td>
                                    <td class="govuk-table__cell govuk-table__cell prepare-text-align-right">
                                        <p class="govuk-!-margin-top-0">
                                            <strong class="govuk-tag govuk-tag--@project.Status.Colour" id="project-status-@project.Id">@project.Status.Value</strong>
                                        </p>
                                        <p class="govuk-hint  govuk-!-margin-top-0">
                                            <span id="application-received-date-@index">
                                                Project created date: @project.CreatedOn.ToDateString()<br>
                                            </span>
                                            @if (ShowHtbDate(project))
                                            {
                                               <span id="@("Advisory-Board-date-" + index)">
                                                  @("Advisory board date: " + project.HeadTeacherBoardDate)<br>
                                               </span>
                                               <span id="@("opening-date-" + index)">
                                                  Opening date:
                                                  @if (string.IsNullOrWhiteSpace(project.ProposedAcademyOpeningDate)) { <span class="empty">EMPTY</span> }
                                                  else
                                                  {
                                                     @project.ProposedAcademyOpeningDate
                                                  }
                                               </span>
                                            }
                                        </p>
                                    </td>
                                </tr>
                                index++;
                            }
                        }
                    </tbody>
                </table>

                <nav class="moj-pagination" id="pagination-label" aria-label="pagination">
                    <p class="govuk-visually-hidden" aria-labelledby="pagination-label">Pagination navigation</p>
                    <ul class="moj-pagination__list">
                        @if (Model.HasPreviousPage)
                        {
                            <li class="moj-pagination__item  moj-pagination__item--prev">
                                <a class="moj-pagination__link" asp-page="/ProjectList/Index" asp-route-currentPage="@Model.PreviousPage" test-id="previousPage">Previous<span class="govuk-visually-hidden"> set of pages</span></a>
                            </li>
                            @for (var i = Model.StartingPage; i < Model.CurrentPage; i++)
                            {
                                <li class="moj-pagination__item">
                                    <a asp-page="/ProjectList/Index" asp-route-currentPage="@i" class="moj-pagination__link">@i</a>
                                </li>
                            }
                        }
                        <li class="moj-pagination__item moj-pagination__item--active">@Model.CurrentPage</li>
                        @if (Model.HasNextPage)
                        {
                            <li class="moj-pagination__item">
                                <a asp-page="/ProjectList/Index" asp-route-currentPage="@Model.NextPage" class="moj-pagination__link">@Model.NextPage</a>
                            </li>
                            <li class="moj-pagination__item  moj-pagination__item--next">
                                <a class="moj-pagination__link" asp-page="/ProjectList/Index" asp-route-currentPage="@Model.NextPage" test-id="nextPage">Next<span class="govuk-visually-hidden"> set of pages</span></a>
                            </li>
                        }
                    </ul>
                    <p class="moj-pagination__results"></p>
                </nav>
            }
        }
    </div>
</div>